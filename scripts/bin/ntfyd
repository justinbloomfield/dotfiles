#!/bin/sh
# notification daemon, ripped from tudorom and z3bra

NTFY_FIFO_PATH=${NTFY_FIFO_PATH:-/home/poq/var/ntfy/ntfy.fifo}
NTFY_COUNT_PATH=${NTFY_COUNT_PATH:-/home/poq/var/ntfy/ntfy.cnt}

# birth the fifo

test -p "$NTFY_FIFO_PATH" || mkfifo "$NTFY_FIFO_PATH"

# screen params
SCR_X="$(wattr x `lsw -r`)"
SCR_Y="$(wattr y `lsw -r`)"
SCR_W="$(wattr w `lsw -r`)"
SCR_H="$(wattr h `lsw -r`)"

# notification params
GAP="40"
PP_W="${PP_W:-150}"
PP_H="${PP_H:-40}"
PP_X="$(( SCR_X - SCR_W - GAP ))"
PP_MEMES="${PP_MEMES:-2}"
PP_Y=40
BORD_C="#d8e6e7"
BORD_W=2
BAR_FG="#d8e6e7"
BAR_BG="#254348"

# count
cnt=0
echo "$cnt" > "$NTFY_COUNT_PATH"

# watch fifo
tail -f "$NTFY_FIFO_PATH" | while IFS= read -r msg; do
    # increase counter
    cnt="$(cat "$NTFY_COUNT_PATH")"
    cnt="$(( cnt + 1 ))"
    echo "$cnt" > "$NTFY_COUNT_PATH"

# the business end, prints the message

{
	(echo "$msg" | skroll -r -n 20 & sleep 3) | lemonbar -d -g "$PP_W"x"$PP_H"+$(( SCR_W - PP_W - GAP ))+$(( SCR_H - (PP_H * PP_MEMES * cnt) )) -F "$BAR_FG" -f metis -B "$BAR_BG" -R "$BORD_C" -r "$BORD_C" #"$msg"
    cnt="$(cat "$NTFY_COUNT_PATH")"
    cnt="$(( cnt - 1 ))"
    echo "$cnt" > "$NTFY_COUNT_PATH"
  } &
done
